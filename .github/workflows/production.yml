name: Production CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  PYTHON_VERSION: "3.13"

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Unit Tests
        run: |
          PYTHONPATH=. pytest agentic_workflow/tests/ -v --cov=agentic_workflow --cov-report=xml
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Image
        run: |
          docker build -t sovereign-stack:${{ github.sha }} .
          docker build -t sovereign-stack:latest .
      
      - name: Save Image
        run: |
          docker save sovereign-stack:latest | gzip > sovereign-stack.tar.gz
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: sovereign-stack.tar.gz
          retention-days: 7

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker Image
        run: |
          docker load < sovereign-stack.tar.gz
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Validate K8s Manifests
        run: |
          echo "âœ… Validating Kubernetes manifests..."
          kubectl apply -f infra/k8s/sovereign-stack-deployment.yaml --dry-run=client
          echo "âœ… Manifest validation successful"
      
      - name: Deployment Info
        run: |
          echo "ðŸ“¦ Docker image loaded: sovereign-stack:latest"
          echo "ðŸ” Manifest validated: infra/k8s/sovereign-stack-deployment.yaml"
          echo "âš ï¸  Real deployment requires K8s cluster credentials"
          echo "   Add KUBE_CONFIG secret to enable automated deployment"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install Security Tools
        run: |
          pip install safety bandit
      
      - name: Python Dependency Security Check
        run: |
          pip install -r requirements.txt
          safety check --json --output safety-report.json || true
      
      - name: Run Bandit Security Scanner
        run: |
          bandit -r agentic_workflow/ engine/ -f json -o bandit-report.json || true
      
      - name: Upload Safety Report
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: safety-report.json
      
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
