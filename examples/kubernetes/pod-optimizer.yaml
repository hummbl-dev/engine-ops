# Kubernetes Pod Placement Example
#
# This example demonstrates how to use Engine-Ops to optimize
# pod placement across nodes in a Kubernetes cluster.

apiVersion: v1
kind: ConfigMap
metadata:
  name: pod-optimizer-config
  namespace: default
data:
  engine-ops-url: 'http://engine-ops.default.svc.cluster.local:3000'
  optimization-type: 'resource'
  target-utilization: '0.85'

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-placement-optimizer
  namespace: default
spec:
  schedule: '*/30 * * * *' # Every 30 minutes
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: pod-optimizer
        spec:
          serviceAccountName: engine-ops-optimizer
          restartPolicy: OnFailure
          containers:
            - name: optimizer
              image: curlimages/curl:latest
              env:
                - name: ENGINE_OPS_URL
                  valueFrom:
                    configMapKeyRef:
                      name: pod-optimizer-config
                      key: engine-ops-url
                - name: API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: engine-ops-api-key
                      key: api-key
              command:
                - /bin/sh
                - -c
                - |
                  # Fetch current pod distribution
                  curl -X POST $ENGINE_OPS_URL/api/v1/optimize \
                    -H "X-API-Key: $API_KEY" \
                    -H "Content-Type: application/json" \
                    -d '{
                      "id": "pod-placement-'$(date +%s)'",
                      "type": "resource",
                      "data": {
                        "items": [
                          {"id": "nginx-1", "cpu": 500, "memory": 1024},
                          {"id": "nginx-2", "cpu": 500, "memory": 1024},
                          {"id": "redis-1", "cpu": 250, "memory": 512}
                        ],
                        "nodeCapacity": {"cpu": 2000, "memory": 4096}
                      }
                    }'

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: engine-ops-optimizer
  namespace: default

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: engine-ops-optimizer
rules:
  - apiGroups: ['']
    resources: ['pods', 'nodes']
    verbs: ['get', 'list', 'watch']
  - apiGroups: ['apps']
    resources: ['deployments', 'replicasets']
    verbs: ['get', 'list', 'watch', 'update', 'patch']

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: engine-ops-optimizer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: engine-ops-optimizer
subjects:
  - kind: ServiceAccount
    name: engine-ops-optimizer
    namespace: default
